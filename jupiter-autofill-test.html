<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jupiter Autofill Test - MoonFeed</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        .test-section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #333;
        }
        .coin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .coin-card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.2s;
        }
        .coin-card:hover {
            border-color: #8B5CF6;
            transform: translateY(-2px);
        }
        .coin-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 8px;
        }
        .coin-address {
            font-family: 'Monaco', monospace;
            font-size: 12px;
            color: #888;
            word-break: break-all;
            margin-bottom: 8px;
        }
        .coin-price {
            color: #06B6D4;
            font-weight: 500;
        }
        .jupiter-container {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            min-height: 500px;
            border: 1px solid #333;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .test-info {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #8B5CF6;
        }
        .selected-coin {
            border-color: #8B5CF6 !important;
            background: rgba(139, 92, 246, 0.1);
        }
        button {
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Jupiter Autofill Test - MoonFeed</h1>
        
        <div class="test-section">
            <h2>Test Instructions</h2>
            <div class="test-info">
                <p><strong>How to test:</strong></p>
                <ol>
                    <li>Click on any coin card below to select it</li>
                    <li>Click "Load Jupiter Trading Interface" button</li>
                    <li>Verify that the selected coin is automatically preloaded in the Jupiter interface</li>
                    <li>Check browser console for detailed logging</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h2>Sample Coins from MoonFeed API</h2>
            <div id="coin-loading" class="loading">Loading trending coins from API...</div>
            <div id="coin-grid" class="coin-grid" style="display: none;"></div>
            <div id="selected-coin-info" style="display: none; margin-top: 16px;">
                <h3>Selected Coin:</h3>
                <pre id="coin-data" style="background: #333; padding: 16px; border-radius: 8px; overflow-x: auto;"></pre>
                <button id="load-jupiter" onclick="loadJupiterForSelectedCoin()" disabled>
                    Load Jupiter Trading Interface
                </button>
            </div>
        </div>

        <div class="test-section">
            <h2>Jupiter Trading Interface</h2>
            <div id="jupiter-container" class="jupiter-container">
                <div class="loading">
                    Select a coin above and click "Load Jupiter Trading Interface" to test autofill functionality.
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedCoin = null;
        let jupiterLoaded = false;

        // Sample coins for testing (will be replaced with API data)
        const sampleCoins = [
            {
                name: "Hemule",
                symbol: "HEMULE", 
                tokenAddress: "0x1274832e134256c0684f04ac6d1f332d37c2bd4d",
                chainId: "ethereum",
                priceUsd: "0.001810"
            },
            {
                name: "HeavenScan",
                symbol: "HeavenScan",
                tokenAddress: "FSSifiykhMBkp2EceqGnHYB5nYW9dyzYz8PYACwBZ777", 
                chainId: "solana",
                priceUsd: "0.00005382"
            }
        ];

        // Load trending coins from API
        async function loadTrendingCoins() {
            try {
                const response = await fetch('http://localhost:3001/api/coins/trending');
                const data = await response.json();
                displayCoins(data.coins || sampleCoins);
            } catch (error) {
                console.error('Failed to load coins from API:', error);
                displayCoins(sampleCoins);
            }
        }

        function displayCoins(coins) {
            const coinGrid = document.getElementById('coin-grid');
            const loading = document.getElementById('coin-loading');
            
            loading.style.display = 'none';
            coinGrid.style.display = 'grid';
            
            coinGrid.innerHTML = coins.slice(0, 6).map((coin, index) => `
                <div class="coin-card" onclick="selectCoin(${index}, ${JSON.stringify(coin).replace(/"/g, '&quot;')})">
                    <div class="coin-name">${coin.name} (${coin.symbol})</div>
                    <div class="coin-address">${coin.tokenAddress}</div>
                    <div class="coin-price">$${coin.priceUsd}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        Chain: ${coin.chainId} | Click to select
                    </div>
                </div>
            `).join('');
        }

        function selectCoin(index, coin) {
            // Remove previous selection
            document.querySelectorAll('.coin-card').forEach(card => {
                card.classList.remove('selected-coin');
            });
            
            // Select new coin
            document.querySelectorAll('.coin-card')[index].classList.add('selected-coin');
            selectedCoin = coin;
            
            // Show selected coin info
            document.getElementById('selected-coin-info').style.display = 'block';
            document.getElementById('coin-data').textContent = JSON.stringify(coin, null, 2);
            document.getElementById('load-jupiter').disabled = false;
            
            console.log('Selected coin for Jupiter trading:', coin);
        }

        async function loadJupiterForSelectedCoin() {
            if (!selectedCoin) {
                alert('Please select a coin first');
                return;
            }

            const container = document.getElementById('jupiter-container');
            const button = document.getElementById('load-jupiter');
            
            button.disabled = true;
            button.textContent = 'Loading Jupiter...';
            
            // Clear container
            container.innerHTML = '<div class="loading">Loading Jupiter Plugin...</div>';
            
            // Only load Solana tokens (Jupiter doesn't support Ethereum)
            if (selectedCoin.chainId !== 'solana') {
                container.innerHTML = `
                    <div class="loading" style="color: #ff6b6b;">
                        ‚ùå Jupiter only supports Solana tokens. 
                        <br>Selected coin "${selectedCoin.name}" is on ${selectedCoin.chainId}.
                        <br>Please select a Solana-based coin instead.
                    </div>
                `;
                button.disabled = false;
                button.textContent = 'Load Jupiter Trading Interface';
                return;
            }

            try {
                // Load Jupiter script if not already loaded
                if (!window.Jupiter || !window.Jupiter.init) {
                    await loadJupiterScript();
                }

                // Wait a bit for script to initialize
                await new Promise(resolve => setTimeout(resolve, 300));

                // Create Jupiter container
                container.innerHTML = '<div id="jupiter-terminal-container" style="width: 100%; min-height: 500px;"></div>';

                // Get mint address with same logic as the app
                const outputMint = selectedCoin.tokenAddress || 
                                 selectedCoin.mint || 
                                 selectedCoin.ca || 
                                 selectedCoin.address ||
                                 selectedCoin.baseToken?.address ||
                                 selectedCoin.id;

                console.log('üéØ Jupiter Autofill Test - Coin Data:', {
                    selectedCoin: {
                        name: selectedCoin.name,
                        symbol: selectedCoin.symbol,
                        tokenAddress: selectedCoin.tokenAddress,
                        mint: selectedCoin.mint,
                        ca: selectedCoin.ca,
                        address: selectedCoin.address,
                        baseTokenAddress: selectedCoin.baseToken?.address,
                        id: selectedCoin.id
                    },
                    resolvedOutputMint: outputMint,
                    willPrefill: !!outputMint,
                    mintLength: outputMint?.length
                });

                if (!outputMint) {
                    throw new Error('No valid mint address found for this coin');
                }

                // Initialize Jupiter with the selected coin
                window.Jupiter.init({
                    displayMode: 'integrated',
                    integratedTargetId: 'jupiter-terminal-container',
                    
                    formProps: {
                        initialOutputMint: outputMint,
                        initialInputMint: 'So11111111111111111111111111111111111111112', // SOL
                        swapMode: 'ExactIn',
                        initialAmount: '',
                    },
                    
                    containerStyles: {
                        maxHeight: '600px',
                        borderRadius: '16px',
                        border: 'none',
                    },
                    
                    branding: {
                        logoUri: '/vite.svg',
                        name: 'MoonFeed Test',
                    },
                    
                    defaultExplorer: 'SolanaFM',
                    
                    onSuccess: (transactionId) => {
                        console.log('‚úÖ Jupiter trade successful:', transactionId);
                    },
                    onError: (error) => {
                        console.error('‚ùå Jupiter trade error:', error);
                    },
                });

                console.log('‚úÖ Jupiter initialized successfully for', selectedCoin.name);
                console.log('üéØ Coin should be preselected:', outputMint);
                
                button.textContent = 'Jupiter Loaded ‚úÖ';
                
            } catch (error) {
                console.error('Failed to load Jupiter:', error);
                container.innerHTML = `
                    <div class="loading" style="color: #ff6b6b;">
                        ‚ùå Failed to load Jupiter: ${error.message}
                        <br>Check console for details.
                    </div>
                `;
                button.disabled = false;
                button.textContent = 'Load Jupiter Trading Interface';
            }
        }

        function loadJupiterScript() {
            return new Promise((resolve, reject) => {
                if (document.querySelector('script[src*="terminal.jup.ag"]')) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://terminal.jup.ag/main-v4.js'; // Official Jupiter Terminal v4
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Load coins when page loads
        loadTrendingCoins();
    </script>
</body>
</html>
